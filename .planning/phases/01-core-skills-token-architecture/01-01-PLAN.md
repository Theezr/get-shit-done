---
phase: 01-core-skills-token-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/skills/gsd-plan-phase/SKILL.md
  - ~/.claude/skills/gsd-plan-phase/references/agents/gsd-phase-researcher.md
  - ~/.claude/skills/gsd-plan-phase/references/agents/gsd-planner.md
  - ~/.claude/skills/gsd-plan-phase/references/agents/gsd-plan-checker.md
autonomous: true

must_haves:
  truths:
    - "Invoking /gsd:plan-phase triggers the new SKILL.md skill, not the old command"
    - "Plan-phase skill spawns researcher, planner, and checker agents from references/agents/ using absolute paths"
    - "Agents receive file paths in their spawn prompts and read files themselves (no content injection)"
    - "SKILL.md body is under 1,500 tokens of orchestration logic"
    - "Plan-phase skill cannot implement code (allowed-tools restricts to Read, Write, Bash, Glob, Grep, Task)"
  artifacts:
    - path: "~/.claude/skills/gsd-plan-phase/SKILL.md"
      provides: "Plan-phase orchestrator skill"
      contains: "name: gsd-plan-phase"
    - path: "~/.claude/skills/gsd-plan-phase/references/agents/gsd-phase-researcher.md"
      provides: "Researcher agent definition"
      contains: "gsd-phase-researcher"
    - path: "~/.claude/skills/gsd-plan-phase/references/agents/gsd-planner.md"
      provides: "Planner agent definition"
      contains: "gsd-planner"
    - path: "~/.claude/skills/gsd-plan-phase/references/agents/gsd-plan-checker.md"
      provides: "Plan checker agent definition"
      contains: "gsd-plan-checker"
  key_links:
    - from: "~/.claude/skills/gsd-plan-phase/SKILL.md"
      to: "references/agents/gsd-phase-researcher.md"
      via: "Task prompt with absolute path"
      pattern: "~/.claude/skills/gsd-plan-phase/references/agents/gsd-phase-researcher.md"
    - from: "~/.claude/skills/gsd-plan-phase/SKILL.md"
      to: "references/agents/gsd-planner.md"
      via: "Task prompt with absolute path"
      pattern: "~/.claude/skills/gsd-plan-phase/references/agents/gsd-planner.md"
    - from: "~/.claude/skills/gsd-plan-phase/SKILL.md"
      to: "references/agents/gsd-plan-checker.md"
      via: "Task prompt with absolute path"
      pattern: "~/.claude/skills/gsd-plan-phase/references/agents/gsd-plan-checker.md"
---

<objective>
Create the gsd-plan-phase skill as a proper SKILL.md with frontmatter, lean orchestrator body, and agent definitions in references/agents/.

Purpose: Convert plan-phase from a command+workflow architecture (377 lines, content injection) to a SKILL.md architecture (lean body + references/) with path-based context passing. This satisfies SKILL-01, SKILL-05 (plan-phase agents), TOKEN-01 (path-based), TOKEN-02 (lean body), PIPE-02 (read-only), and PIPE-06 (allowed-tools).

Output: `~/.claude/skills/gsd-plan-phase/` directory with SKILL.md and 3 agent definitions in references/agents/.
</objective>

<execution_context>
@/Users/nick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-core-skills-token-architecture/01-RESEARCH.md

Source files to convert:
@/Users/nick/.claude/get-shit-done/workflows/plan-phase.md

Existing agent definitions to move:
@/Users/nick/.claude/agents/gsd-phase-researcher.md
@/Users/nick/.claude/agents/gsd-planner.md
@/Users/nick/.claude/agents/gsd-plan-checker.md

Reference skill for pattern:
@/Users/nick/.claude/skills/security-review/SKILL.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gsd-plan-phase SKILL.md with frontmatter and lean orchestrator body</name>
  <files>~/.claude/skills/gsd-plan-phase/SKILL.md</files>
  <action>
Create the directory `~/.claude/skills/gsd-plan-phase/` and write SKILL.md.

**Frontmatter (YAML):**
```yaml
name: gsd-plan-phase
description: >
  Create detailed execution plans for a roadmap phase. Orchestrates research,
  planning, and verification agents. Use when user says "plan phase",
  "create plan for phase", "/gsd:plan-phase", or wants to plan the next
  phase of their project. Requires .planning/ directory with ROADMAP.md.
argument-hint: "<phase-number> [--research] [--skip-research] [--gaps] [--skip-verify]"
allowed-tools:
  - Read
  - Write
  - Bash
  - Glob
  - Grep
  - Task
  - WebFetch
  - mcp__context7__resolve-library-id
  - mcp__context7__query-docs
```

NOTE: No Edit tool in allowed-tools. This enforces PIPE-02 (planner never implements code). The skill can Read files and Write plan documents, but cannot Edit source code.

**Body structure (~100-150 lines, target <1,500 tokens):**

The body must be a lean orchestration sequence with these steps. Do NOT copy the full workflow file (377 lines). Extract only the orchestration logic:

1. **Initialize** -- `gsd-tools.cjs init plan-phase "$PHASE"` (NO `--include` flag -- agents read files themselves). Parse: phase_dir, models, flags, has_research, has_plans, etc.

2. **Parse Arguments** -- Extract phase number, flags (--research, --skip-research, --gaps, --skip-verify). Auto-detect next phase if not specified.

3. **Handle Research (conditional)** -- Skip if: --gaps, --skip-research, research_enabled=false, or RESEARCH.md exists. Otherwise spawn researcher:
   ```
   Task(
     prompt="First, read ~/.claude/skills/gsd-plan-phase/references/agents/gsd-phase-researcher.md for your role.
     <objective>Research Phase {N}: {name}</objective>
     <files_to_read>
     - .planning/STATE.md
     - .planning/ROADMAP.md (Phase {N} section)
     - .planning/REQUIREMENTS.md (Phase {N} requirements)
     - {phase_dir}/*-CONTEXT.md (if exists)
     </files_to_read>
     <output>Write to: {phase_dir}/{padded_phase}-RESEARCH.md</output>",
     subagent_type="general-purpose"
   )
   ```
   Key: pass file PATHS, not content. ~30 tokens per spawn instead of ~5,000.

4. **Spawn Planner** -- Spawn gsd-planner with path-based context:
   ```
   Task(
     prompt="First, read ~/.claude/skills/gsd-plan-phase/references/agents/gsd-planner.md for your role.
     <planning_context>
     Phase: {N}, Mode: {standard|gap_closure}
     Phase directory: {phase_dir}
     </planning_context>
     <files_to_read>
     - .planning/STATE.md
     - .planning/ROADMAP.md
     - .planning/REQUIREMENTS.md
     - {phase_dir}/*-RESEARCH.md (if exists)
     - {phase_dir}/*-CONTEXT.md (if exists)
     - {phase_dir}/*-VERIFICATION.md (if --gaps)
     - {phase_dir}/*-UAT.md (if --gaps)
     </files_to_read>
     <downstream_consumer>
     Output consumed by /gsd:execute-phase. Plans need frontmatter, XML tasks, verification, must_haves.
     </downstream_consumer>",
     subagent_type="general-purpose"
   )
   ```

5. **Verify Plans (conditional)** -- Skip if --skip-verify or plan_checker_enabled=false. Spawn checker:
   ```
   Task(
     prompt="First, read ~/.claude/skills/gsd-plan-phase/references/agents/gsd-plan-checker.md for your role.
     <verification_context>
     Phase: {N}, Goal: {goal}
     Phase directory: {phase_dir}
     </verification_context>
     <files_to_read>
     - {phase_dir}/*-PLAN.md (all plans)
     - .planning/REQUIREMENTS.md (Phase {N} requirements)
     - {phase_dir}/*-CONTEXT.md (if exists)
     </files_to_read>",
     subagent_type="general-purpose"
   )
   ```

6. **Revision Loop (max 3)** -- If checker returns ISSUES FOUND, re-spawn planner with issue list and plan paths. Max 3 iterations.

7. **Present Results** -- Display plan count, wave breakdown, offer `/gsd:execute-phase {X}`.

**Critical rules for the body:**
- NEVER use `--include` flag on gsd-tools.cjs init (that loads content -- defeats path-based passing)
- All Task prompts use ABSOLUTE paths to references/agents/ (e.g., `~/.claude/skills/gsd-plan-phase/references/agents/gsd-planner.md`)
- All Task prompts tell agents to READ files themselves (list paths in `<files_to_read>`)
- Orchestrator NEVER reads agent output files (follows security-review pattern)
- Agent returns are one-line structured signals (e.g., "PLANNING COMPLETE: 3 plans")
  </action>
  <verify>
1. `[ -f ~/.claude/skills/gsd-plan-phase/SKILL.md ]` -- file exists
2. `head -20 ~/.claude/skills/gsd-plan-phase/SKILL.md` -- has frontmatter with name, description, allowed-tools
3. `grep -c "Edit" ~/.claude/skills/gsd-plan-phase/SKILL.md` returns 0 (no Edit tool)
4. `wc -w ~/.claude/skills/gsd-plan-phase/SKILL.md` -- under 1,500 words (proxy for tokens)
5. `grep "references/agents/gsd-planner.md" ~/.claude/skills/gsd-plan-phase/SKILL.md` -- absolute path reference exists
6. `grep -c "\-\-include" ~/.claude/skills/gsd-plan-phase/SKILL.md` returns 0 (no content injection)
  </verify>
  <done>
SKILL.md exists at ~/.claude/skills/gsd-plan-phase/SKILL.md with: YAML frontmatter (name: gsd-plan-phase, allowed-tools without Edit), lean body under 1,500 tokens, 7 orchestration steps, all agent spawns use absolute paths to references/agents/, all agents receive file paths (not content), no --include flag usage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Copy and adapt agent definitions to references/agents/</name>
  <files>
~/.claude/skills/gsd-plan-phase/references/agents/gsd-phase-researcher.md
~/.claude/skills/gsd-plan-phase/references/agents/gsd-planner.md
~/.claude/skills/gsd-plan-phase/references/agents/gsd-plan-checker.md
  </files>
  <action>
Create directory `~/.claude/skills/gsd-plan-phase/references/agents/` and copy the 3 agent definitions.

**For each agent file:**

1. **gsd-phase-researcher.md** (453 lines):
   - Copy from `~/.claude/agents/gsd-phase-researcher.md`
   - Update any self-referencing paths (if the agent references its own location)
   - Verify it has no hardcoded content injection patterns (it should instruct the agent to read files, not expect content in the prompt)

2. **gsd-planner.md** (1157 lines):
   - Copy from `~/.claude/agents/gsd-planner.md`
   - The planner's `<execution_flow>` section references `gsd-tools.cjs` commands -- keep these as-is (gsd-tools.cjs is NOT being removed)
   - Update the `<execution_flow>` step `load_project_state` to remove the `--include` flag pattern. The planner should read files via Read tool, not expect content from the orchestrator's init call
   - Verify `<plan_format>` section's `<execution_context>` references point to correct paths (the execute-plan.md workflow will still exist at `~/.claude/get-shit-done/workflows/execute-plan.md` for now)

3. **gsd-plan-checker.md** (622 lines):
   - Copy from `~/.claude/agents/gsd-plan-checker.md`
   - Update any patterns where the checker expects plan content to be injected in its prompt -- it should read plan files itself from the phase directory path

**Key adaptations for all agents:**
- Remove any patterns that assume content is injected in the spawn prompt
- Add explicit "Read these files at execution start" instructions if not already present
- Ensure agents reference `gsd-tools.cjs` by its full path: `/Users/nick/.claude/get-shit-done/bin/gsd-tools.cjs`
- Do NOT change the agent's core logic, task breakdown format, or planning methodology
- Do NOT remove the `---` frontmatter from agent files (they have name/description/tools/color)

**What NOT to change:**
- The planner's task anatomy, dependency graph, scope estimation, goal-backward methodology
- The checker's verification dimensions and scoring
- The researcher's research structure and output format
- gsd-tools.cjs command usage patterns
  </action>
  <verify>
1. `[ -f ~/.claude/skills/gsd-plan-phase/references/agents/gsd-phase-researcher.md ]` -- exists
2. `[ -f ~/.claude/skills/gsd-plan-phase/references/agents/gsd-planner.md ]` -- exists
3. `[ -f ~/.claude/skills/gsd-plan-phase/references/agents/gsd-plan-checker.md ]` -- exists
4. `wc -l ~/.claude/skills/gsd-plan-phase/references/agents/gsd-planner.md` -- approximately 1100+ lines (core logic preserved)
5. `grep -c "\-\-include" ~/.claude/skills/gsd-plan-phase/references/agents/gsd-planner.md` returns 0 (no content injection pattern)
6. `grep "gsd-tools" ~/.claude/skills/gsd-plan-phase/references/agents/gsd-planner.md` -- still references gsd-tools.cjs
  </verify>
  <done>
Three agent definition files exist at ~/.claude/skills/gsd-plan-phase/references/agents/ with core logic intact, --include patterns removed, and agents instructed to read files themselves via Read tool.
  </done>
</task>

</tasks>

<verification>
1. Full directory structure exists:
   ```
   ~/.claude/skills/gsd-plan-phase/
     SKILL.md
     references/
       agents/
         gsd-phase-researcher.md
         gsd-planner.md
         gsd-plan-checker.md
   ```
2. SKILL.md frontmatter has: name, description, argument-hint, allowed-tools (without Edit)
3. SKILL.md body references all 3 agents by absolute path
4. No --include flag usage in SKILL.md or agent files
5. Agent definitions preserve their core logic (planner ~1100+ lines, researcher ~450 lines, checker ~600 lines)
</verification>

<success_criteria>
- gsd-plan-phase/SKILL.md exists with proper frontmatter and lean body (<1,500 tokens)
- 3 agent definitions live in references/agents/ (not standalone in ~/.claude/agents/)
- All agent spawns use absolute paths to references/agents/
- Agents receive file paths (not injected content) -- TOKEN-01 satisfied
- No Edit tool in allowed-tools -- PIPE-02 (planner never implements) satisfied
- allowed-tools explicitly listed -- PIPE-06 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/01-core-skills-token-architecture/01-01-SUMMARY.md`
</output>
