---
phase: 02-mcp-powered-planning-execution
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/gsd-execute-phase/references/agents/gsd-executor.md
  - skills/gsd-execute-phase/SKILL.md
autonomous: true

must_haves:
  truths:
    - "Executor agent verifies plan API references via Context7 before implementing each task"
    - "Executor agent reads RESEARCH.md first to avoid re-querying already-documented libraries"
    - "Executor agent loads relevant best-practice skills before writing code based on task technology"
    - "Executor records which skills were loaded in SUMMARY.md frontmatter"
    - "Execute-phase SKILL.md allowed-tools includes Context7 MCP tools"
  artifacts:
    - path: "skills/gsd-execute-phase/references/agents/gsd-executor.md"
      provides: "Executor agent with proactive MCP verification and skill loading"
      contains: "<mcp_protocol>"
    - path: "skills/gsd-execute-phase/references/agents/gsd-executor.md"
      provides: "Best-practice skill loading section"
      contains: "<best_practice_skills>"
    - path: "skills/gsd-execute-phase/SKILL.md"
      provides: "Execute-phase orchestrator with Context7 in allowed-tools and updated spawn prompt"
      contains: "mcp__context7__resolve-library-id"
  key_links:
    - from: "skills/gsd-execute-phase/SKILL.md"
      to: "skills/gsd-execute-phase/references/agents/gsd-executor.md"
      via: "Spawn prompt instructs executor to verify APIs and load skills"
      pattern: "Verify the plan.*Context7"
    - from: "skills/gsd-execute-phase/references/agents/gsd-executor.md"
      to: "RESEARCH.md"
      via: "mcp_protocol reads RESEARCH.md before Context7 re-queries"
      pattern: "RESEARCH.md"
    - from: "skills/gsd-execute-phase/references/agents/gsd-executor.md"
      to: "~/.claude/skills/*/SKILL.md"
      via: "best_practice_skills detection heuristics trigger skill reads"
      pattern: "vercel-react-best-practices"
---

<objective>
Add proactive pre-implementation API verification and best-practice skill loading to the execute-phase skill's executor agent, and update the orchestrator's allowed-tools and spawn prompt.

Purpose: Satisfy MCP-04 (Context7 verification in executor) and MCP-05 (best-practice skill loading) so that every task implementation uses verified current APIs and follows established code quality patterns.

Output: Modified executor agent with `<mcp_protocol>` and `<best_practice_skills>` sections, updated execute-phase SKILL.md allowed-tools and spawn prompt.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mcp-powered-planning-execution/02-RESEARCH.md
@docs/nick/execute.md
</context>

<critical_context>
This phase modifies REPO source files at skills/gsd-*/. NOT the installed copies at ~/.claude/skills/.

The repo files at /Users/nick/Documents/git/get-shit-done/skills/ are the source of truth. The install script copies them to ~/.claude/skills/. After modifying repo files, ALSO copy the updated files to ~/.claude/skills/ so the running system picks up changes immediately.
</critical_context>

<tasks>

<task type="auto">
  <name>Task 1: Replace executor tool_strategy with proactive MCP protocol and add best-practice skills</name>
  <files>
    skills/gsd-execute-phase/references/agents/gsd-executor.md
  </files>
  <action>
**Executor agent (`gsd-executor.md`):**

1. Replace the existing `<tool_strategy>` section (lines ~16-33, the reactive "When to use: Unsure about a library's API" section) with a new `<mcp_protocol>` section. The new section has 3 steps:

   **Step 1: Read RESEARCH.md (if exists)**
   - Before any Context7 calls, check if the researcher already documented the libraries
   - Read `$PHASE_DIR/*-RESEARCH.md`
   - If RESEARCH.md covers the library's API you need, skip Context7 for that library

   **Step 2: Context7 API Verification**
   - For each library referenced in the task's `<action>` that is NOT covered in RESEARCH.md:
     a. `mcp__context7__resolve-library-id` with library name
     b. `mcp__context7__query-docs` with resolved ID + specific API from the plan
   - Compare plan's API usage with Context7 results:
     - Match: Proceed with plan's instructions
     - Mismatch: Adapt to current API. Document deviation: "Plan referenced X, current API is Y"
     - Not found in Context7: Proceed with plan's instructions (plan was already researched)
   - When NOT to verify: Pure codebase-internal work (no external library APIs), configuration-only tasks, file copy/move tasks
   - Efficiency: Batch resolve-library-id calls. Only query-docs for APIs you are about to use

   **Step 3: Load Best-Practice Skills**
   - (Brief note pointing to the `<best_practice_skills>` section below)

   Use `02-RESEARCH.md` section "Pattern 4: Executor Pre-Implementation API Verification" and "Code Examples > Example 2" as authoritative reference for the content.

2. Add a NEW `<best_practice_skills>` section AFTER the `</mcp_protocol>` closing tag and BEFORE `<execution_flow>`. Contents:

   **Header:** "Load Best-Practice Skills Before Writing Code"
   **MANDATORY:** Before implementing code in a task, read the relevant best-practice skill SKILL.md files.

   **Detection Heuristics table:**
   | Task Indicators | Skill to Load | Skill Path |
   |---|---|---|
   | React components, hooks, Next.js pages/routes, JSX/TSX files | vercel-react-best-practices | `~/.claude/skills/vercel-react-best-practices/SKILL.md` |
   | NestJS controllers, services, modules, decorators | nestjs-best-practices | `~/.claude/skills/nestjs-best-practices/SKILL.md` |
   | Visual components, pages, layouts, UI styling, accessibility | web-design-guidelines | `~/.claude/skills/web-design-guidelines/SKILL.md` |
   | Auth, input validation, API endpoints, user data, secrets | owasp-security | `~/.claude/skills/owasp-security/SKILL.md` |

   Note: Use `web-design-guidelines` (not `frontend-design` which does not exist).

   **How to Load:**
   1. Read SKILL.md first for rule categories and priorities
   2. For detailed rules, read referenced files in `references/` as needed
   3. Apply CRITICAL-priority rules as hard requirements
   4. Apply HIGH-priority rules as strong recommendations

   **Loading Strategy:**
   - Read SKILL.md first (rule summary + references to detailed docs)
   - Read specific `references/` only for categories relevant to your task
   - Multiple skills can apply (e.g., React + OWASP for a login form)
   - Do NOT load all skills for every task -- only match task indicators

   Use `02-RESEARCH.md` section "Pattern 5: Best-Practice Skill Loading" as authoritative reference.

3. Update the `<summary_creation>` section to add skill tracking. After the existing frontmatter fields list (which mentions "phase, plan, subsystem, tags, dependency graph, tech-stack, key-files, decisions, metrics"), add:

   "If best-practice skills were loaded during execution, add to frontmatter:
   ```yaml
   skills-loaded:
     - vercel-react-best-practices
     - owasp-security
   ```
   List only skills actually read during this plan's execution."

4. After modifying the repo file, copy to installed location:
   ```bash
   cp skills/gsd-execute-phase/references/agents/gsd-executor.md ~/.claude/skills/gsd-execute-phase/references/agents/
   ```
  </action>
  <verify>
1. Grep for `<mcp_protocol>` in executor -- must exist
2. Grep for `<best_practice_skills>` in executor -- must exist
3. Grep for `<tool_strategy>` in executor -- must NOT exist (replaced by mcp_protocol)
4. Grep for `vercel-react-best-practices` in executor -- must exist
5. Grep for `web-design-guidelines` in executor -- must exist (not `frontend-design`)
6. Grep for `frontend-design` in executor -- must NOT exist
7. Grep for `skills-loaded` in executor summary_creation section -- must exist
8. Grep for `RESEARCH.md` in executor mcp_protocol -- must exist (read-before-query pattern)
9. Verify installed copy matches: `diff skills/gsd-execute-phase/references/agents/gsd-executor.md ~/.claude/skills/gsd-execute-phase/references/agents/gsd-executor.md`
  </verify>
  <done>
Executor agent has `<mcp_protocol>` with proactive pre-implementation API verification (read RESEARCH.md first, then Context7 for uncovered APIs). Executor has `<best_practice_skills>` with detection heuristics for 4 skill categories using `web-design-guidelines` (not the non-existent `frontend-design`). Summary creation includes skills-loaded tracking. Old reactive `<tool_strategy>` is removed. Repo and installed copies match.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update execute-phase SKILL.md allowed-tools and spawn prompt</name>
  <files>
    skills/gsd-execute-phase/SKILL.md
  </files>
  <action>
**Execute-phase SKILL.md:**

1. Add Context7 MCP tools to the `allowed-tools:` list. Currently the list ends at `Task`. Add after `- Task`:
   ```yaml
   - mcp__context7__resolve-library-id
   - mcp__context7__query-docs
   ```

2. Update the executor spawn prompt in Step 4b. The current `<objective>` block says:
   ```
   Execute plan {plan_id} of phase {phase_number}-{phase_name}.
   Commit each task atomically. Create SUMMARY.md. Update STATE.md.
   ```
   Change to:
   ```
   Execute plan {plan_id} of phase {phase_number}-{phase_name}.

   BEFORE implementing each task:
   1. Verify the plan's API references via Context7 (check RESEARCH.md first)
   2. Load relevant best-practice skills for the technology being used

   Commit each task atomically. Create SUMMARY.md (include skills-loaded). Update STATE.md.
   ```

3. Update the `<files_to_read>` block in the executor spawn prompt. Currently:
   ```
   - Plan: {phase_dir}/{plan_file}
   - State: .planning/STATE.md
   - Config: .planning/config.json (if exists)
   ```
   Add a RESEARCH.md entry:
   ```
   - Plan: {phase_dir}/{plan_file}
   - Research: {phase_dir}/*-RESEARCH.md (if exists -- check for pre-verified APIs)
   - State: .planning/STATE.md
   - Config: .planning/config.json (if exists)
   ```

4. Update the `<success_criteria>` block in the executor spawn prompt. Currently:
   ```
   - [ ] All tasks executed
   - [ ] Each task committed individually
   - [ ] SUMMARY.md created in plan directory
   - [ ] STATE.md updated with position and decisions
   ```
   Add two criteria at the top:
   ```
   - [ ] API references verified via Context7 before implementation (or confirmed in RESEARCH.md)
   - [ ] Relevant best-practice skills loaded before writing code
   - [ ] All tasks executed
   - [ ] Each task committed individually
   - [ ] SUMMARY.md created with skills-loaded field
   - [ ] STATE.md updated with position and decisions
   ```

5. After modifying the repo file, copy to installed location:
   ```bash
   cp skills/gsd-execute-phase/SKILL.md ~/.claude/skills/gsd-execute-phase/
   ```
  </action>
  <verify>
1. Grep for `mcp__context7__resolve-library-id` in SKILL.md allowed-tools -- must exist
2. Grep for `mcp__context7__query-docs` in SKILL.md allowed-tools -- must exist
3. Grep for "Verify the plan" in SKILL.md spawn prompt -- must exist
4. Grep for "best-practice skills" in SKILL.md spawn prompt -- must exist
5. Grep for "RESEARCH.md" in SKILL.md files_to_read -- must exist
6. Grep for "skills-loaded" in SKILL.md success_criteria -- must exist
7. Verify installed copy matches: `diff skills/gsd-execute-phase/SKILL.md ~/.claude/skills/gsd-execute-phase/SKILL.md`
  </verify>
  <done>
Execute-phase SKILL.md has Context7 tools in allowed-tools. Spawn prompt instructs executor to verify APIs and load skills before implementing. Files_to_read includes RESEARCH.md. Success criteria includes API verification and skills-loaded tracking. Repo and installed copies match.
  </done>
</task>

</tasks>

<verification>
1. Both execute-phase skill files modified in repo at `skills/gsd-execute-phase/`
2. Both installed copies at `~/.claude/skills/gsd-execute-phase/` match repo versions
3. Executor has `<mcp_protocol>` replacing old `<tool_strategy>` with proactive verification
4. Executor has `<best_practice_skills>` with 4-skill detection heuristics
5. SKILL.md allowed-tools includes Context7 tools
6. Spawn prompt mentions pre-implementation verification and skill loading
</verification>

<success_criteria>
- MCP-04: Executor verifies plan API references via Context7 before implementing (enforced by `<mcp_protocol>` with RESEARCH.md-first pattern and Context7 fallback)
- MCP-05: Executor loads relevant best-practice skills before writing code (enforced by `<best_practice_skills>` with detection heuristics for react, nestjs, web-design, owasp)
- All files exist in both repo and installed locations
</success_criteria>

<output>
After completion, create `.planning/phases/02-mcp-powered-planning-execution/02-02-SUMMARY.md`
</output>
