---
phase: 02-mcp-powered-planning-execution
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/gsd-plan-phase/references/agents/gsd-phase-researcher.md
  - skills/gsd-plan-phase/SKILL.md
  - skills/gsd-plan-phase/references/agents/gsd-planner.md
  - skills/gsd-plan-phase/references/agents/gsd-plan-checker.md
autonomous: true

must_haves:
  truths:
    - "Researcher agent performs mandatory Context7 2-step lookup for every library a phase touches"
    - "Researcher agent performs microsoft-docs 3-step lookup when Azure services are involved"
    - "Researcher agent uses Context7/WebFetch fallback for shadcn/ui when shadcn MCP is unavailable"
    - "Researcher records confidence tags (HIGH/MEDIUM/LOW) based on source in RESEARCH.md"
    - "Plan-phase SKILL.md allowed-tools includes microsoft-docs MCP tools"
  artifacts:
    - path: "skills/gsd-plan-phase/references/agents/gsd-phase-researcher.md"
      provides: "Researcher agent with mandatory MCP protocol"
      contains: "<mcp_protocol>"
    - path: "skills/gsd-plan-phase/SKILL.md"
      provides: "Plan-phase orchestrator with expanded allowed-tools"
      contains: "mcp__microsoft-docs__microsoft_docs_search"
    - path: "skills/gsd-plan-phase/references/agents/gsd-planner.md"
      provides: "Planner with awareness of Context7-verified RESEARCH.md"
      contains: "Context7-verified"
    - path: "skills/gsd-plan-phase/references/agents/gsd-plan-checker.md"
      provides: "Checker with optional RESEARCH.md reference check"
      contains: "RESEARCH.md"
  key_links:
    - from: "skills/gsd-plan-phase/SKILL.md"
      to: "skills/gsd-plan-phase/references/agents/gsd-phase-researcher.md"
      via: "allowed-tools enables MCP tools the researcher uses"
      pattern: "mcp__microsoft-docs"
    - from: "skills/gsd-plan-phase/references/agents/gsd-phase-researcher.md"
      to: "RESEARCH.md output"
      via: "mcp_protocol section drives research output with confidence tags"
      pattern: "Confidence Tagging"
---

<objective>
Add mandatory MCP lookup protocols to the plan-phase skill's researcher agent and update the orchestrator's allowed-tools to enable microsoft-docs and shadcn MCP tools.

Purpose: Satisfy MCP-01 (mandatory Context7), MCP-02 (microsoft-docs for Azure), and MCP-03 (shadcn with graceful fallback) so that every RESEARCH.md contains API-verified findings rather than training-data guesses.

Output: Modified researcher agent with `<mcp_protocol>` section, updated plan-phase SKILL.md allowed-tools, minor planner/checker awareness updates.
</objective>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-mcp-powered-planning-execution/02-RESEARCH.md
@docs/nick/plan.md
</context>

<critical_context>
This phase modifies REPO source files at skills/gsd-*/. NOT the installed copies at ~/.claude/skills/.

The repo files at /Users/nick/Documents/git/get-shit-done/skills/ are the source of truth. The install script copies them to ~/.claude/skills/. After modifying repo files, ALSO copy the updated files to ~/.claude/skills/ so the running system picks up changes immediately.
</critical_context>

<tasks>

<task type="auto">
  <name>Task 1: Add MCP protocol to researcher agent and update plan-phase SKILL.md</name>
  <files>
    skills/gsd-plan-phase/references/agents/gsd-phase-researcher.md
    skills/gsd-plan-phase/SKILL.md
  </files>
  <action>
**Researcher agent (`gsd-phase-researcher.md`):**

1. Add `mcp__microsoft-docs__*` to the `tools:` frontmatter line (currently: `tools: Read, Write, Bash, Grep, Glob, WebSearch, WebFetch, mcp__context7__*`). Add after `mcp__context7__*`: `, mcp__microsoft-docs__microsoft_docs_search, mcp__microsoft-docs__microsoft_code_sample_search, mcp__microsoft-docs__microsoft_docs_fetch`

2. Add a new `<mcp_protocol>` section AFTER the existing `</tool_strategy>` closing tag and BEFORE `<source_hierarchy>`. This section contains three subsections:

   **Subsection 1: Mandatory Context7 Lookups**
   - For EVERY external library the phase implementation will touch
   - 2-step: resolve-library-id then query-docs with specific APIs
   - Identify libraries from phase requirements, roadmap goal, existing package.json
   - Record in RESEARCH.md `## Standard Stack` with version and API details
   - "Do NOT skip this. Do NOT assume you know the current API."
   - Fallback chain: Context7 (HIGH) -> WebFetch official docs (MEDIUM) -> Training data (LOW, flagged)
   - Efficiency note: Query framework-level libraries and new deps, NOT Node.js built-ins or trivial utilities

   **Subsection 2: Azure Documentation Lookup (microsoft-docs)**
   - If phase involves ANY Azure service
   - 3-step: microsoft_docs_search -> microsoft_code_sample_search (specify language) -> microsoft_docs_fetch
   - Azure service indicators: `@azure/*` imports, ARM/Bicep files, Azure CLI commands, `process.env.AZURE_*` patterns
   - Record in RESEARCH.md under `## Azure Services` section

   **Subsection 3: UI Component Documentation (shadcn/ui)**
   - If phase involves UI components and project uses shadcn/ui
   - Primary: shadcn MCP tools (when available)
   - Fallback: Context7 resolve "shadcn/ui" then query; if insufficient, WebFetch `https://ui.shadcn.com/docs/components/{name}`
   - Detection: `components.json`, `package.json` shadcn dep, `@/components/ui/` imports
   - Record in RESEARCH.md under `## UI Components` section

   **Subsection 4: Confidence Tagging from Source**
   - Table: Context7 = HIGH, Official docs via WebFetch = MEDIUM, WebSearch cross-verified = MEDIUM, Training data = LOW

3. Update the existing `<tool_strategy>` section to add a note referencing the new `<mcp_protocol>` section: After the existing content, add: "**See `<mcp_protocol>` section below for mandatory lookup protocols that go beyond this priority list.**"

Use the research at `02-RESEARCH.md` sections "Pattern 1", "Pattern 2", "Pattern 3", and "Code Examples > Example 1" as the authoritative content for each subsection. Adapt the content to fit within the existing agent definition style (XML sections, markdown formatting).

**Plan-phase SKILL.md:**

4. Add these tools to the `allowed-tools:` list (after the existing `mcp__context7__query-docs`):
   ```
   - mcp__microsoft-docs__microsoft_docs_search
   - mcp__microsoft-docs__microsoft_code_sample_search
   - mcp__microsoft-docs__microsoft_docs_fetch
   ```

5. In the researcher spawn prompt (Step 3), update the `<objective>` to mention MCP requirements:
   Change from: `Answer: 'What do I need to know to PLAN this phase well?'`
   To: `Answer: 'What do I need to know to PLAN this phase well?' Use mandatory Context7 lookups for every library, microsoft-docs for Azure services, and shadcn fallback for UI components.`

6. After modifying both repo files, copy them to the installed location:
   ```bash
   cp skills/gsd-plan-phase/references/agents/gsd-phase-researcher.md ~/.claude/skills/gsd-plan-phase/references/agents/
   cp skills/gsd-plan-phase/SKILL.md ~/.claude/skills/gsd-plan-phase/
   ```
  </action>
  <verify>
1. Grep for `<mcp_protocol>` in the researcher file -- must exist
2. Grep for `mcp__microsoft-docs__microsoft_docs_search` in researcher frontmatter tools line -- must exist
3. Grep for `mcp__microsoft-docs__microsoft_docs_search` in SKILL.md allowed-tools -- must exist
4. Grep for `Confidence Tagging` in researcher -- must exist (confidence table)
5. Grep for `shadcn` in researcher `<mcp_protocol>` section -- must exist (fallback)
6. Verify installed copies match: `diff skills/gsd-plan-phase/SKILL.md ~/.claude/skills/gsd-plan-phase/SKILL.md`
  </verify>
  <done>
Researcher agent has `<mcp_protocol>` section with mandatory Context7, microsoft-docs, shadcn fallback, and confidence tagging. Plan-phase SKILL.md has microsoft-docs tools in allowed-tools. Researcher spawn prompt mentions MCP requirements. Both repo and installed copies are in sync.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update planner and checker agents with MCP awareness</name>
  <files>
    skills/gsd-plan-phase/references/agents/gsd-planner.md
    skills/gsd-plan-phase/references/agents/gsd-plan-checker.md
  </files>
  <action>
**Planner agent (`gsd-planner.md`):**

1. In the `<discovery_levels>` section, under "Level 1 - Quick Verification", confirm it already mentions Context7. No change needed if it does.

2. In the `gather_phase_context` step (inside `<execution_flow>`), find the line about RESEARCH.md. After the existing text "**If RESEARCH.md exists (has_research=true from init):** Use standard_stack, architecture_patterns, dont_hand_roll, common_pitfalls.", add a new paragraph:

   "**MCP-verified findings:** RESEARCH.md now contains Context7-verified API details with confidence tags (HIGH/MEDIUM/LOW). When RESEARCH.md has HIGH-confidence findings for a library, trust those findings for planning rather than re-querying Context7. Only use Context7 directly for Level 1 quick verification of libraries NOT covered in RESEARCH.md."

3. No other changes to the planner. The researcher handles MCP-01's mandatory lookups and writes to RESEARCH.md; the planner consumes it.

**Plan checker agent (`gsd-plan-checker.md`):**

4. In the `<verification_dimensions>` section, under "Dimension 1: Requirement Coverage", add a new red flag at the end of the existing red flags list:

   "- Plan references specific library APIs but RESEARCH.md (if exists) does not document those libraries -- plan may be using unverified training-data claims"

5. No other changes to the checker. It verifies plan structure, not API accuracy.

6. After modifying both repo files, copy them to the installed location:
   ```bash
   cp skills/gsd-plan-phase/references/agents/gsd-planner.md ~/.claude/skills/gsd-plan-phase/references/agents/
   cp skills/gsd-plan-phase/references/agents/gsd-plan-checker.md ~/.claude/skills/gsd-plan-phase/references/agents/
   ```
  </action>
  <verify>
1. Grep for "MCP-verified findings" in planner -- must exist
2. Grep for "Context7-verified" in planner -- must exist
3. Grep for "unverified training-data" in checker -- must exist
4. Verify installed copies match: `diff skills/gsd-plan-phase/references/agents/gsd-planner.md ~/.claude/skills/gsd-plan-phase/references/agents/gsd-planner.md`
5. Verify installed copies match: `diff skills/gsd-plan-phase/references/agents/gsd-plan-checker.md ~/.claude/skills/gsd-plan-phase/references/agents/gsd-plan-checker.md`
  </verify>
  <done>
Planner agent knows RESEARCH.md now contains Context7-verified findings with confidence tags and trusts HIGH-confidence entries. Checker agent flags plans that reference library APIs without corresponding RESEARCH.md documentation. Both repo and installed copies are in sync.
  </done>
</task>

</tasks>

<verification>
1. All 4 plan-phase skill files modified in repo at `skills/gsd-plan-phase/`
2. All 4 installed copies at `~/.claude/skills/gsd-plan-phase/` match repo versions
3. Researcher has `<mcp_protocol>` with Context7 mandatory, microsoft-docs, shadcn fallback, and confidence tags
4. SKILL.md allowed-tools includes microsoft-docs MCP tools
5. Planner references Context7-verified RESEARCH.md findings
6. Checker can flag unverified API references
</verification>

<success_criteria>
- MCP-01: Researcher performs mandatory Context7 2-step lookup for every library (enforced by `<mcp_protocol>` section with "Do NOT skip" instruction)
- MCP-02: Researcher performs microsoft-docs 3-step lookup for Azure services (enforced by Azure subsection in `<mcp_protocol>`)
- MCP-03: Researcher uses shadcn MCP when available, falls back to Context7/WebFetch (enforced by shadcn subsection with fallback chain)
- All files exist in both repo and installed locations
</success_criteria>

<output>
After completion, create `.planning/phases/02-mcp-powered-planning-execution/02-01-SUMMARY.md`
</output>
