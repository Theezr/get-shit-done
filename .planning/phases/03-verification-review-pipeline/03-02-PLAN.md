---
phase: 03-verification-review-pipeline
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/gsd-review/SKILL.md
  - skills/gsd-review/references/agents/gsd-code-reviewer.md
autonomous: true

must_haves:
  truths:
    - "gsd-review skill exists with YAML frontmatter (name, description, argument-hint, allowed-tools) following Phase 1/2 SKILL.md pattern"
    - "Review skill's allowed-tools includes Bash (for git commit), Read, Write, Task, and mcp__ide__getDiagnostics (MCP-07)"
    - "Code-reviewer agent loads best-practice skills using detection heuristics from Phase 2 executor pattern"
    - "Code-reviewer agent runs IDE diagnostics AND npm run typecheck as belt-and-suspenders (cross-verification per research)"
    - "Review skill commits only after PASS result -- orchestrator reads REVIEW.md result, commits if PASS, blocks if FAIL (PIPE-05)"
    - "Code-reviewer agent produces REVIEW.md with severity-graded findings (Critical/High/Medium/Low) and PASS/FAIL determination"
  artifacts:
    - path: "skills/gsd-review/SKILL.md"
      provides: "Review orchestrator with commit-on-PASS logic"
      min_lines: 60
    - path: "skills/gsd-review/references/agents/gsd-code-reviewer.md"
      provides: "Code review agent with best-practice skill loading and IDE diagnostics"
      min_lines: 100
  key_links:
    - from: "skills/gsd-review/SKILL.md"
      to: "skills/gsd-review/references/agents/gsd-code-reviewer.md"
      via: "Task spawn prompt referencing agent path"
      pattern: "gsd-review/references/agents/gsd-code-reviewer"
    - from: "skills/gsd-review/SKILL.md"
      to: "gsd-tools.js"
      via: "init phase-op call and commit command"
      pattern: "gsd-tools\\.js.*(init|commit)"
    - from: "skills/gsd-review/SKILL.md"
      to: "REVIEW.md result field"
      via: "Orchestrator reads result from REVIEW.md frontmatter to decide commit"
      pattern: "result.*PASS|FAIL"
    - from: "skills/gsd-review/references/agents/gsd-code-reviewer.md"
      to: "Best-practice skills"
      via: "Detection heuristics and skill loading"
      pattern: "~/.claude/skills/.*/SKILL\\.md"
    - from: "skills/gsd-review/references/agents/gsd-code-reviewer.md"
      to: "IDE diagnostics MCP"
      via: "mcp__ide__getDiagnostics tool call"
      pattern: "mcp__ide__getDiagnostics"
---

<objective>
Create the gsd-review skill with SKILL.md orchestrator and code-reviewer agent definition.

Purpose: This skill completes the "review" stage of the plan-execute-verify-review pipeline (PIPE-01). It performs code quality review using best-practice skills and IDE diagnostics, produces a structured REVIEW.md, and commits the executor's work ONLY after a PASS result. Satisfies SKILL-04, MCP-07, and PIPE-05.

Output: `skills/gsd-review/SKILL.md` + `skills/gsd-review/references/agents/gsd-code-reviewer.md` (repo source copies). Installed copies at `~/.claude/skills/gsd-review/`.
</objective>

<execution_context>
@/Users/nick/.claude/get-shit-done/workflows/execute-plan.md
@/Users/nick/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-verification-review-pipeline/03-RESEARCH.md

Reference implementations and established patterns:
@skills/gsd-execute-phase/SKILL.md (established SKILL.md orchestrator pattern)
@skills/gsd-execute-phase/references/agents/gsd-executor.md (best-practice skill loading pattern in <best_practice_skills> section)
@docs/nick/review.md (user's reference review skill -- adapt patterns from this)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create gsd-review SKILL.md orchestrator</name>
  <files>skills/gsd-review/SKILL.md</files>
  <action>
Create `skills/gsd-review/SKILL.md` following the established SKILL.md pattern from Phase 1/2.

**Frontmatter** (YAML between --- delimiters):
- `name: gsd-review`
- `description:` Multi-line description mentioning code quality review, best-practice skill loading, IDE diagnostics, commit-on-PASS. Trigger phrases: "review phase", "review code", "/gsd:review", or after verify-work completes.
- `argument-hint: "<phase-number>"`
- `allowed-tools:` Include Read, Write, Bash, Glob, Grep, Task, and `mcp__ide__getDiagnostics`. Bash is required for `git commit` (PIPE-05). Do NOT include Edit (reviewer reports findings, does not modify source).

**Body** (lean orchestrator, ~80-120 lines, following gsd-execute-phase SKILL.md as template):

Step 1: Initialize
- `INIT=$(node ~/.claude/get-shit-done/bin/gsd-tools.js init phase-op "$PHASE_ARG")`
- Parse: phase_dir, phase_number, phase_name, padded_phase, commit_docs
- Error if phase not found

Step 2: Load Phase Context
- Read SUMMARY.md files from phase directory to identify ALL files created/modified
- Read PLAN.md files for plan adherence checking
- Read RUNTIME-VERIFICATION.md if it exists (include runtime findings in review context)

Step 3: Spawn Code Reviewer
- Use Task tool to spawn code-reviewer agent
- Prompt pattern: "First, read ~/.claude/skills/gsd-review/references/agents/gsd-code-reviewer.md for your role."
- Pass phase info in `<objective>` tags
- Pass file paths in `<files_to_read>` tags (SUMMARY.md, PLAN.md, RUNTIME-VERIFICATION.md if exists) -- NOT content
- Output instruction: Create `{phase_dir}/{padded_phase}-REVIEW.md`
- Use `subagent_type="general-purpose"`

Step 4: Read Review Result
- Parse REVIEW.md frontmatter for `result: PASS | FAIL`

Step 5: Handle Result

**If PASS:**
- Run `git status` to identify all modified/untracked files
- Cross-reference with SUMMARY.md key-files to ensure nothing is missed
- Commit using gsd-tools: `node ~/.claude/get-shit-done/bin/gsd-tools.js commit "docs(phase-{X}): review PASSED -- code quality verified" --files {phase_dir}/{padded_phase}-REVIEW.md {phase_dir}/{padded_phase}-RUNTIME-VERIFICATION.md`
- Display: "Review PASSED. Phase {X} review artifacts committed."
- Note: This commits the REVIEW and VERIFICATION reports only. The executor's code commits are already in git (per-task commits from the executor, per existing PIPE-03 decision). The review GATE validates those commits are quality-approved.

**If FAIL:**
- Do NOT commit anything
- Display critical and high findings from REVIEW.md
- Offer: "Fix issues and re-execute, then re-review: `/gsd:execute-phase {X} --gaps` then `/gsd:review {X}`"

Step 6: Present Results
- Display review summary with findings count by severity
- If PASS: offer next phase planning `/gsd:plan-phase {X+1}`
- If FAIL: offer gap closure path

**Key design decisions:**
- Review skill commits review/verification ARTIFACTS, not the executor's code (executor commits per-task, per deferred PIPE-03 decision from Phase 1)
- This implements PIPE-05 as a quality GATE: review PASS means the executor's commits are approved; FAIL means they need fixing
- No Edit in allowed-tools: reviewer reports findings, does not modify source
- Belt-and-suspenders: IDE diagnostics + npm run typecheck (code-reviewer agent handles this)
  </action>
  <verify>
File exists at `skills/gsd-review/SKILL.md`. File starts with YAML frontmatter containing `name: gsd-review`. Frontmatter includes `mcp__ide__getDiagnostics` in allowed-tools. Frontmatter includes `Bash` in allowed-tools (needed for commit). Frontmatter does NOT include `Edit`. Body contains init step using gsd-tools.js. Body contains Task spawn referencing `gsd-code-reviewer.md`. Body contains PASS/FAIL handling with commit-on-PASS logic. Body contains gsd-tools.js commit command in PASS path.
  </verify>
  <done>
SKILL.md exists with correct frontmatter (name, description, argument-hint, allowed-tools with IDE diagnostics and Bash, no Edit), lean orchestrator body (~80-120 lines) with 6 steps (init, load context, spawn reviewer, read result, handle result with commit-on-PASS, present), and path-based agent spawning pattern matching Phase 1/2 skills.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create gsd-code-reviewer agent definition</name>
  <files>skills/gsd-review/references/agents/gsd-code-reviewer.md</files>
  <action>
Create `skills/gsd-review/references/agents/gsd-code-reviewer.md` following the established agent definition pattern from gsd-executor.md and gsd-verifier.md.

**Frontmatter:**
```yaml
---
name: gsd-code-reviewer
description: Code quality reviewer that loads best-practice skills, runs IDE diagnostics, and produces structured review with severity levels. Does NOT modify source files. Does NOT commit.
tools: Read, Bash, Grep, Glob, Write, mcp__ide__getDiagnostics
color: purple
---
```

**Structure** (adapt from docs/nick/review.md reference implementation and the agent definition pattern from gsd-executor.md):

`<role>` section:
- Code reviewer that reviews executed code for quality, security, and best-practice compliance
- Produces structured REVIEW.md with severity-graded findings
- Does NOT modify source files, does NOT commit code
- The orchestrator handles commits based on the PASS/FAIL result

`<review_protocol>` section -- Mandatory Review Steps:

### 1. Identify Files to Review
- Read SUMMARY.md files from the phase
- Extract ALL created/modified file paths from key-files sections
- If no SUMMARY.md found, error: "No execution summaries found -- nothing to review"

### 2. Load Best-Practice Skills (adapted from Phase 2 executor's <best_practice_skills> section)
Detection heuristics table:
| File Patterns | Skill to Load | Skill Path |
|---------------|---------------|------------|
| *.tsx, *.jsx, page.tsx, layout.tsx, hooks, React components | vercel-react-best-practices | `~/.claude/skills/vercel-react-best-practices/SKILL.md` |
| *.controller.ts, *.service.ts, *.module.ts, NestJS decorators | nestjs-best-practices | `~/.claude/skills/nestjs-best-practices/SKILL.md` |
| UI components, layouts, visual files, CSS/styling | web-design-guidelines | `~/.claude/skills/web-design-guidelines/SKILL.md` |
| Auth, validation, API endpoints, user data, secrets, env vars | owasp-security | `~/.claude/skills/owasp-security/SKILL.md` |

Loading strategy:
- Read SKILL.md first (rule summary), then specific references/ only for relevant categories
- Do NOT load all skills for every review -- only what file patterns match
- Multiple skills can apply to one review (e.g., React + OWASP for auth UI)
- Track loaded skills for REVIEW.md frontmatter

### 3. Read and Review Every File
Read ALL files from SUMMARY.md key-files. Check for:
- Logic errors, edge cases, missing error handling
- TypeScript strictness (no `any` casts, proper types, strict null checks)
- Code clarity and maintainability
- Plan adherence (does code match the plan's intent?)
- Anti-patterns specific to loaded best-practice skills

### 4. Run IDE Diagnostics (Belt-and-Suspenders)
Step A: Run IDE diagnostics
```
mcp__ide__getDiagnostics
```
Record all errors and warnings.

Step B: Cross-verify with TypeScript compiler
```bash
npm run typecheck 2>&1
```
- If IDE diagnostics shows errors that typecheck does NOT: ignore (false positives from IDE)
- If typecheck shows errors that IDE diagnostics missed: include (false negatives from IDE)
- If both agree: high confidence finding
- Note: IDE diagnostics may return stale errors for files not open in editor (known issue per research)

### 5. Run Test Suite and Build (if available)
```bash
npm run test 2>&1 || echo "No test script"
npm run build 2>&1 || echo "No build script"
```
Record results: PASS/FAIL/N/A for each.

### 6. Check Plan Adherence
- Compare implemented code against PLAN.md task actions
- Note any deviations (acceptable if documented in SUMMARY.md deviations section)
- Flag undocumented deviations as Medium findings

### 7. Determine Result
- **PASS:** Zero Critical findings AND zero High findings
- **FAIL:** Any Critical or High finding present
- Medium and Low findings are documented but do NOT block

`<severity_levels>` section:
- **Critical (must fix):** Security vulnerabilities, data loss potential, broken core functionality, crashes
- **High (should fix):** Type errors, missing error handling, violations of critical best-practice rules, unhandled edge cases
- **Medium (fix later):** Code clarity issues, minor best-practice deviations, undocumented plan deviations
- **Low (nice to have):** Style suggestions, optimization opportunities, documentation improvements

`<report_output>` section -- REVIEW.md structure:
Frontmatter with:
```yaml
---
phase: XX-name
reviewed: YYYY-MM-DDTHH:MM:SSZ
result: PASS | FAIL
skills_loaded:
  - vercel-react-best-practices
  - owasp-security
diagnostics:
  typecheck: PASS | FAIL | N/A
  tests: PASS | FAIL | N/A
  build: PASS | FAIL | N/A
  ide_errors: N
findings:
  critical: N
  high: N
  medium: N
  low: N
---
```

Body sections:
- Result: PASS / FAIL (prominent)
- Critical Findings (file:line, issue, fix recommendation)
- High Findings (file:line, issue, recommendation)
- Medium Findings (file, issue, suggestion)
- Low Findings (observation)
- Best Practices Review (Violations Found + Patterns Confirmed)
- Test Results (typecheck, unit tests, build)
- Plan Adherence (match or deviations noted)
- Summary (brief overall assessment)

`<critical_rules>` section:
- NEVER modify source files -- report findings only (Write is for REVIEW.md only)
- NEVER commit -- the orchestrator handles commits based on result
- ALWAYS load at least one best-practice skill (detect from file patterns)
- ALWAYS run IDE diagnostics AND typecheck (belt-and-suspenders)
- Write REVIEW.md BEFORE returning result -- never return result without file
- Be specific: file paths, line numbers, concrete fix recommendations
- Distinguish severity levels -- not everything is critical

`<success_criteria>` section:
- [ ] All files from SUMMARY.md key-files read and reviewed
- [ ] Relevant best-practice skills loaded based on file patterns
- [ ] IDE diagnostics run and cross-verified with typecheck
- [ ] Test suite and build checked (if available)
- [ ] Plan adherence verified
- [ ] REVIEW.md created with severity-graded findings
- [ ] Result determined (PASS if zero Critical + zero High)
- [ ] Results returned to orchestrator (NOT committed)

**Agent should be ~200-300 lines** total, following the density level of gsd-executor.md (~476 lines for a more complex agent) but scaled appropriately for the review scope.
  </action>
  <verify>
File exists at `skills/gsd-review/references/agents/gsd-code-reviewer.md`. File starts with YAML frontmatter containing `name: gsd-code-reviewer`. File contains `<review_protocol>` section with 7 mandatory review steps. File contains `<severity_levels>` section with Critical/High/Medium/Low definitions. File contains `<report_output>` section with REVIEW.md template including `result: PASS | FAIL` in frontmatter. File contains belt-and-suspenders pattern (IDE diagnostics + typecheck). File contains detection heuristics table for best-practice skill loading. File contains `<critical_rules>` with "NEVER modify source files" and "NEVER commit".
  </verify>
  <done>
gsd-code-reviewer.md exists with correct frontmatter, review protocol with 7 steps (identify files, load skills, read files, IDE diagnostics + typecheck, test suite, plan adherence, determine result), severity levels, REVIEW.md template with PASS/FAIL, belt-and-suspenders diagnostics, best-practice skill loading heuristics, and critical rules enforcing read-only + no-commit behavior.
  </done>
</task>

<task type="auto">
  <name>Task 3: Install skill to ~/.claude/skills/ and verify structure</name>
  <files>skills/gsd-review/SKILL.md, skills/gsd-review/references/agents/gsd-code-reviewer.md</files>
  <action>
Copy the repo source skill to the installed location, matching the pattern established in Phase 1:

1. Create directory structure:
```bash
mkdir -p ~/.claude/skills/gsd-review/references/agents/
```

2. Copy files:
```bash
cp skills/gsd-review/SKILL.md ~/.claude/skills/gsd-review/SKILL.md
cp skills/gsd-review/references/agents/gsd-code-reviewer.md ~/.claude/skills/gsd-review/references/agents/gsd-code-reviewer.md
```

3. Verify installed structure:
```bash
ls -la ~/.claude/skills/gsd-review/
ls -la ~/.claude/skills/gsd-review/references/agents/
```

4. Verify SKILL.md frontmatter is valid:
```bash
head -5 ~/.claude/skills/gsd-review/SKILL.md
```

5. Verify PIPE-05 enforcement: grep the SKILL.md body for commit-on-PASS pattern:
```bash
grep -c "PASS" ~/.claude/skills/gsd-review/SKILL.md
# Should return 2+ (in PASS handling section)
grep -c "gsd-tools.js.*commit" ~/.claude/skills/gsd-review/SKILL.md
# Should return 1+ (commit command in PASS path)
```

6. Verify MCP-07: IDE diagnostics in allowed-tools:
```bash
grep "mcp__ide__getDiagnostics" ~/.claude/skills/gsd-review/SKILL.md
# Should match in allowed-tools
```

7. Verify no Edit in allowed-tools:
```bash
grep -A 15 "allowed-tools:" ~/.claude/skills/gsd-review/SKILL.md | grep -c "Edit"
# Should return 0
```

8. Verify all 4 skills now exist in the pipeline:
```bash
ls ~/.claude/skills/gsd-plan-phase/SKILL.md
ls ~/.claude/skills/gsd-execute-phase/SKILL.md
ls ~/.claude/skills/gsd-verify-work/SKILL.md
ls ~/.claude/skills/gsd-review/SKILL.md
```
This verifies PIPE-01: all four pipeline stages have skills.
  </action>
  <verify>
`~/.claude/skills/gsd-review/SKILL.md` exists. `~/.claude/skills/gsd-review/references/agents/gsd-code-reviewer.md` exists. `grep "mcp__ide__getDiagnostics" ~/.claude/skills/gsd-review/SKILL.md` matches. `grep -A 15 "allowed-tools:" ~/.claude/skills/gsd-review/SKILL.md | grep -c "Edit"` returns 0. All four pipeline skills exist at `~/.claude/skills/gsd-{plan-phase,execute-phase,verify-work,review}/SKILL.md`.
  </verify>
  <done>
gsd-review skill installed at ~/.claude/skills/ with correct directory structure. SKILL.md has IDE diagnostics MCP and Bash in allowed-tools. Edit tool is NOT in allowed-tools. Commit-on-PASS logic is in the orchestrator body. All four pipeline stage skills (plan, execute, verify, review) exist at ~/.claude/skills/ -- PIPE-01 pipeline completeness verified.
  </done>
</task>

</tasks>

<verification>
1. `skills/gsd-review/SKILL.md` exists with valid YAML frontmatter (name, description, argument-hint, allowed-tools)
2. `skills/gsd-review/references/agents/gsd-code-reviewer.md` exists with valid agent frontmatter
3. SKILL.md follows lean orchestrator pattern (~80-120 lines body)
4. SKILL.md allowed-tools includes mcp__ide__getDiagnostics (MCP-07)
5. SKILL.md allowed-tools includes Bash (needed for git commit in PASS path)
6. SKILL.md allowed-tools does NOT include Edit
7. SKILL.md body contains commit-on-PASS logic (PIPE-05)
8. SKILL.md body contains FAIL handling that blocks commit
9. Code-reviewer agent includes best-practice skill loading with detection heuristics
10. Code-reviewer agent includes belt-and-suspenders (IDE diagnostics + typecheck)
11. Code-reviewer agent writes REVIEW.md with PASS/FAIL result and severity-graded findings
12. Code-reviewer agent critical rules forbid source modification and commits
13. Installed copies exist at ~/.claude/skills/gsd-review/
14. All four pipeline skills exist (PIPE-01 completeness)
</verification>

<success_criteria>
- SKILL-04 satisfied: review skill checks code quality, loads best-practice skills, and has commit-on-PASS logic
- MCP-07 satisfied: code-reviewer agent uses mcp__ide__getDiagnostics for TypeScript error checking
- PIPE-05 satisfied: reviewer commits only after review result is PASS; no commit on FAIL
- PIPE-01 satisfied: all four pipeline stages (plan, execute, verify, review) exist as skills
- Skill follows established SKILL.md architecture from Phase 1/2 (lean body, agents in references/, path-based context passing)
- Both repo source (skills/) and installed (~/.claude/skills/) copies exist
</success_criteria>

<output>
After completion, create `.planning/phases/03-verification-review-pipeline/03-02-SUMMARY.md`
</output>
