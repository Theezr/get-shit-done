---
phase: 04-resilience-optimization
plan: 03
type: execute
wave: 2
depends_on: ["04-02"]
files_modified:
  - skills/gsd-execute-phase/references/agents/gsd-executor.md
  - skills/gsd-execute-phase/references/agents/gsd-executor-checkpoints.md
  - skills/gsd-execute-phase/references/agents/gsd-executor-tdd.md
  - skills/gsd-execute-phase/SKILL.md
  - ~/.claude/agents/gsd-executor.md
autonomous: true

must_haves:
  truths:
    - "Executor core agent definition does NOT contain checkpoint_protocol, checkpoint_return_format, continuation_handling, authentication_gates, or tdd_execution sections"
    - "gsd-executor-checkpoints.md contains checkpoint_protocol, checkpoint_return_format, continuation_handling, and authentication_gates sections"
    - "gsd-executor-tdd.md contains tdd_execution section"
    - "Execute-phase SKILL.md conditionally includes checkpoint/TDD reference files based on plan frontmatter"
    - "Continuation agents always receive the checkpoints reference file regardless of conditional loading"
  artifacts:
    - path: "skills/gsd-execute-phase/references/agents/gsd-executor.md"
      provides: "Core executor agent definition (always loaded)"
      contains: "mcp_degradation"
    - path: "skills/gsd-execute-phase/references/agents/gsd-executor-checkpoints.md"
      provides: "Checkpoint protocol, return format, continuation, auth gates"
      contains: "checkpoint_protocol"
    - path: "skills/gsd-execute-phase/references/agents/gsd-executor-tdd.md"
      provides: "TDD execution protocol"
      contains: "tdd_execution"
    - path: "skills/gsd-execute-phase/SKILL.md"
      provides: "Conditional reference loading in orchestrator"
      contains: "autonomous"
  key_links:
    - from: "skills/gsd-execute-phase/SKILL.md"
      to: "gsd-executor-checkpoints.md"
      via: "conditional @-reference when autonomous=false"
      pattern: "autonomous.*false.*checkpoints"
    - from: "skills/gsd-execute-phase/SKILL.md"
      to: "gsd-executor-tdd.md"
      via: "conditional @-reference when type=tdd"
      pattern: "type.*tdd"
---

<objective>
Split the executor agent definition into core + conditional files and update the execute-phase orchestrator to load them conditionally based on plan frontmatter.

Purpose: Reduce token consumption (TOKEN-05) by ~34% for standard executor invocations that do not need checkpoint or TDD protocols.
Output: Three executor files (core, checkpoints, TDD) and updated SKILL.md orchestrator with conditional loading.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-resilience-optimization/04-RESEARCH.md
@.planning/phases/04-resilience-optimization/04-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Split executor agent definition into core + checkpoints + TDD files</name>
  <files>
    skills/gsd-execute-phase/references/agents/gsd-executor.md
    skills/gsd-execute-phase/references/agents/gsd-executor-checkpoints.md
    skills/gsd-execute-phase/references/agents/gsd-executor-tdd.md
    ~/.claude/agents/gsd-executor.md
  </files>
  <action>
Read the current `gsd-executor.md` (which now includes the `<mcp_degradation>` section from Plan 04-02). Split it into three files:

**File 1: gsd-executor.md (core -- always loaded)**

Keep these sections in the core file:
- YAML frontmatter (name, description, tools, color)
- `<role>`
- `<mcp_protocol>` (pre-implementation API verification)
- `<mcp_degradation>` (added by Plan 04-02)
- `<best_practice_skills>`
- `<execution_flow>`
- `<deviation_rules>`
- `<task_commit_protocol>`
- `<summary_creation>`
- `<self_check>`
- `<state_updates>`
- `<final_commit>`
- `<completion_format>`
- `<success_criteria>`

REMOVE these sections from the core file (they move to separate files):
- `<authentication_gates>`
- `<checkpoint_protocol>`
- `<checkpoint_return_format>`
- `<continuation_handling>`
- `<tdd_execution>`

In the `<execution_flow>` section, the `<step name="determine_execution_pattern">` references Pattern B (checkpoints) and Pattern C (continuation). Update this step to note: "For checkpoint and continuation handling, see the checkpoint reference file loaded by the orchestrator when autonomous=false."

Similarly, in `<step name="execute_tasks">`, item 2 references checkpoints. Update to: "If `type="checkpoint:*"`: STOP immediately -- follow checkpoint protocol from the checkpoint reference file."

**File 2: gsd-executor-checkpoints.md (conditional -- loaded when autonomous=false)**

Create a new file with NO YAML frontmatter (it is a reference file, not a standalone agent). Content:

```markdown
# Executor Checkpoint Protocol

These sections apply when the plan has `autonomous: false` (contains checkpoint tasks).

<authentication_gates>
{EXACT content from the original gsd-executor.md <authentication_gates> section}
</authentication_gates>

<checkpoint_protocol>
{EXACT content from the original gsd-executor.md <checkpoint_protocol> section}
</checkpoint_protocol>

<checkpoint_return_format>
{EXACT content from the original gsd-executor.md <checkpoint_return_format> section}
</checkpoint_return_format>

<continuation_handling>
{EXACT content from the original gsd-executor.md <continuation_handling> section}
</continuation_handling>
```

Preserve ALL content verbatim. Do not summarize, rephrase, or omit anything from these sections.

**File 3: gsd-executor-tdd.md (conditional -- loaded when type=tdd)**

Create a new file with NO YAML frontmatter. Content:

```markdown
# Executor TDD Protocol

This section applies when the plan has `type: tdd`.

<tdd_execution>
{EXACT content from the original gsd-executor.md <tdd_execution> section}
</tdd_execution>
```

Preserve ALL content verbatim.

**File 4: Sync global copy**

Copy the updated core `gsd-executor.md` to `~/.claude/agents/gsd-executor.md`. The global copy only needs the core -- checkpoint and TDD references are loaded by the orchestrator when needed.
  </action>
  <verify>
1. Grep gsd-executor.md for "checkpoint_protocol" -- should NOT be found (moved out)
2. Grep gsd-executor.md for "tdd_execution" -- should NOT be found (moved out)
3. Grep gsd-executor.md for "mcp_degradation" -- SHOULD be found (kept in core)
4. Grep gsd-executor-checkpoints.md for "checkpoint_protocol" -- SHOULD be found
5. Grep gsd-executor-checkpoints.md for "continuation_handling" -- SHOULD be found
6. Grep gsd-executor-checkpoints.md for "authentication_gates" -- SHOULD be found
7. Grep gsd-executor-tdd.md for "tdd_execution" -- SHOULD be found
8. Confirm line counts: core should be ~340 lines (was ~475), checkpoints ~90 lines, TDD ~20 lines
  </verify>
  <done>
Executor agent split into three files. Core file contains all always-needed sections. Checkpoint file contains all checkpoint/continuation/auth-gate sections. TDD file contains TDD execution protocol. No content lost -- all sections preserved verbatim in their new locations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update execute-phase SKILL.md for conditional reference loading</name>
  <files>skills/gsd-execute-phase/SKILL.md</files>
  <action>
Modify the execute-phase SKILL.md orchestrator to conditionally include checkpoint and TDD reference files based on plan frontmatter.

**Step 1: Update Step 3 (Discover and Group Plans)**

After the existing `PLAN_INDEX` parsing, add a note that `type` is now available in the plan index (from Plan 04-01's gsd-tools.js change):

```markdown
Parse: `plans[]` (each with `id`, `wave`, `autonomous`, `type`, `objective`, `has_summary`), `waves`, `incomplete`.
```

**Step 2: Update Step 4b (Spawn executor agents)**

Replace the current `<execution_context>` block in the Task prompt with a conditionally-built version. The orchestrator constructs the execution_context based on each plan's frontmatter:

Replace the existing Task prompt's `<execution_context>` section:
```
  <execution_context>
  Read these workflow files for execution instructions:
  @~/.claude/get-shit-done/workflows/execute-plan.md
  @~/.claude/get-shit-done/templates/summary.md
  @~/.claude/get-shit-done/references/checkpoints.md
  @~/.claude/get-shit-done/references/tdd.md
  </execution_context>
```

With this conditional version:
```
  <execution_context>
  Read these workflow files for execution instructions:
  @~/.claude/get-shit-done/workflows/execute-plan.md
  @~/.claude/get-shit-done/templates/summary.md
  {IF plan.autonomous === false:}
  Also read the checkpoint protocol:
  @~/.claude/skills/gsd-execute-phase/references/agents/gsd-executor-checkpoints.md
  {IF plan.type === "tdd":}
  Also read the TDD execution protocol:
  @~/.claude/skills/gsd-execute-phase/references/agents/gsd-executor-tdd.md
  </execution_context>
```

**Important:** The `{IF ...}` notation is pseudo-code for the orchestrator. Since the orchestrator is a Claude agent reading this SKILL.md as its instructions, write it as a clear instruction to the orchestrator:

```markdown
  <execution_context>
  Read these workflow files for execution instructions:
  @~/.claude/get-shit-done/workflows/execute-plan.md
  @~/.claude/get-shit-done/templates/summary.md
  </execution_context>

  **Conditional references (include in execution_context based on plan frontmatter):**
  - If the plan's `autonomous` is `false`: Add this line to execution_context:
    `@~/.claude/skills/gsd-execute-phase/references/agents/gsd-executor-checkpoints.md`
  - If the plan's `type` is `tdd`: Add this line to execution_context:
    `@~/.claude/skills/gsd-execute-phase/references/agents/gsd-executor-tdd.md`
```

**Step 3: Update Step 4e (Handle checkpoint plans)**

When spawning a continuation agent (after a checkpoint), the continuation agent MUST always include the checkpoints reference file. Add this note:

```markdown
**4e. Handle checkpoint plans** (`autonomous: false`): Agent returns structured state. Present to user. Spawn fresh continuation agent with completed tasks table and resume point. **IMPORTANT:** The continuation agent's execution_context MUST include gsd-executor-checkpoints.md -- continuation handling is in that file.
```

**Step 4: Remove the old always-loaded references**

Remove `@~/.claude/get-shit-done/references/checkpoints.md` and `@~/.claude/get-shit-done/references/tdd.md` from the execution_context (these were the old GSD workflow references; the new checkpoint and TDD content is now in the skill's own references/agents/ directory).
  </action>
  <verify>
1. Read the updated SKILL.md and confirm the execution_context no longer always includes checkpoints.md and tdd.md
2. Confirm conditional loading instructions reference gsd-executor-checkpoints.md and gsd-executor-tdd.md
3. Confirm Step 4e mentions continuation agents must include checkpoints reference
4. Confirm Step 3 now mentions `type` in the plan index parsing
  </verify>
  <done>
Execute-phase SKILL.md orchestrator conditionally includes checkpoint and TDD reference files based on plan frontmatter. Standard autonomous plans skip checkpoint and TDD loading, saving ~34% tokens. Continuation agents always get checkpoint references. Plan type field is parsed from plan index.
  </done>
</task>

</tasks>

<verification>
1. Core gsd-executor.md does NOT contain checkpoint_protocol, checkpoint_return_format, continuation_handling, authentication_gates, or tdd_execution
2. gsd-executor-checkpoints.md contains all checkpoint-related sections verbatim
3. gsd-executor-tdd.md contains the TDD execution section verbatim
4. Execute-phase SKILL.md has conditional loading logic based on `autonomous` and `type`
5. Continuation agent handling explicitly includes checkpoints reference
6. No content lost -- all sections from original executor exist in exactly one of the three files
</verification>

<success_criteria>
TOKEN-05 is complete: executor agent definition is split into core (~66%) + checkpoints (~27%) + TDD (~7%). Orchestrator loads only what each plan needs. Standard autonomous non-TDD plans get only the core definition, saving ~1,450 tokens per invocation.
</success_criteria>

<output>
After completion, create `.planning/phases/04-resilience-optimization/04-03-SUMMARY.md`
</output>
