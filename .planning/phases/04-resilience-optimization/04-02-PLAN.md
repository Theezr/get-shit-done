---
phase: 04-resilience-optimization
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - skills/gsd-plan-phase/references/agents/gsd-phase-researcher.md
  - skills/gsd-execute-phase/references/agents/gsd-executor.md
  - skills/gsd-verify-work/references/agents/gsd-browser-tester.md
  - skills/gsd-review/references/agents/gsd-code-reviewer.md
  - skills/gsd-plan-phase/references/agents/gsd-planner.md
  - ~/.claude/agents/gsd-phase-researcher.md
  - ~/.claude/agents/gsd-executor.md
autonomous: true

must_haves:
  truths:
    - "Researcher agent attempts a pre-flight MCP check before using Context7 and falls back to WebSearch when unavailable"
    - "Executor agent attempts a pre-flight Context7 check and tags findings with degraded confidence when falling back"
    - "Browser-tester agent already has pre-flight; it now tags confidence in its report"
    - "Code-reviewer agent handles IDE diagnostics unavailability gracefully with explicit fallback"
    - "Planner agent checks RESEARCH.md before Context7 queries (TOKEN-03 consistency)"
    - "All MCP-using agents include try/catch around individual MCP calls even after pre-flight succeeds"
  artifacts:
    - path: "skills/gsd-plan-phase/references/agents/gsd-phase-researcher.md"
      provides: "MCP degradation protocol for researcher"
      contains: "mcp_degradation"
    - path: "skills/gsd-execute-phase/references/agents/gsd-executor.md"
      provides: "MCP degradation protocol for executor"
      contains: "mcp_degradation"
    - path: "skills/gsd-verify-work/references/agents/gsd-browser-tester.md"
      provides: "Confidence tagging in verification report"
      contains: "confidence"
    - path: "skills/gsd-review/references/agents/gsd-code-reviewer.md"
      provides: "IDE diagnostics fallback handling"
      contains: "mcp_degradation"
    - path: "skills/gsd-plan-phase/references/agents/gsd-planner.md"
      provides: "RESEARCH.md-first protocol for planner"
      contains: "RESEARCH.md"
  key_links:
    - from: "gsd-phase-researcher.md <mcp_degradation>"
      to: "Context7 tools"
      via: "pre-flight resolve-library-id check"
      pattern: "context7_available"
    - from: "gsd-executor.md <mcp_degradation>"
      to: "Context7 tools"
      via: "pre-flight check in mcp_protocol"
      pattern: "context7_available"
---

<objective>
Add graceful MCP degradation to all MCP-using agent definitions and complete TOKEN-03 research caching consistency.

Purpose: Make all skills resilient to MCP unavailability (MCP-08) and ensure all agents read RESEARCH.md before querying MCPs (TOKEN-03).
Output: Updated agent definitions with `<mcp_degradation>` sections and RESEARCH.md-first pattern in planner.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-resilience-optimization/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add MCP degradation to researcher and executor agent definitions</name>
  <files>
    skills/gsd-plan-phase/references/agents/gsd-phase-researcher.md
    skills/gsd-execute-phase/references/agents/gsd-executor.md
    ~/.claude/agents/gsd-phase-researcher.md
    ~/.claude/agents/gsd-executor.md
  </files>
  <action>
**Part A: Researcher agent (gsd-phase-researcher.md)**

Add a new `<mcp_degradation>` section AFTER the existing `<mcp_protocol>` section. Content:

```markdown
<mcp_degradation>

## Pre-flight MCP Availability

At the start of your research session, test each MCP you plan to use. Run these checks ONCE at session start, not before every call.

### Context7
Attempt: `mcp__context7__resolve-library-id` with libraryName="react" query="react library"
- **Success:** Set context7_available = true. Use Context7 for all library lookups. Confidence = HIGH.
- **Failure:** Set context7_available = false. Fall back to WebSearch + WebFetch for all library lookups. Tag findings as MEDIUM confidence max.

### microsoft-docs (if phase involves Azure)
Attempt: `mcp__microsoft-docs__microsoft_docs_search` with query="Azure App Service"
- **Success:** Set microsoft_docs_available = true. Use for Azure documentation.
- **Failure:** Set microsoft_docs_available = false. Fall back to WebSearch + WebFetch.

### Mid-Session Failures
Even after pre-flight succeeds, wrap individual MCP calls in try/catch. If an MCP call fails mid-session:
1. Log the failure: "Context7 became unavailable mid-session"
2. Switch to fallback path for remaining calls
3. Downgrade confidence for all subsequent findings to MEDIUM max
4. Do NOT retry the same MCP call -- assume it is down for the rest of the session

### Confidence with Degradation

| MCP Available | Source Used | Confidence |
|---------------|------------|------------|
| Yes | MCP result found | HIGH |
| Yes | MCP no result, WebFetch official docs | MEDIUM |
| No | WebSearch + official source | MEDIUM |
| No | WebSearch only | LOW |
| No | Training data only | LOW |

</mcp_degradation>
```

**Part B: Executor agent (gsd-executor.md)**

Add a new `<mcp_degradation>` section AFTER the existing `<mcp_protocol>` section. Content:

```markdown
<mcp_degradation>

## Pre-flight MCP Availability

At the start of your execution session, test Context7 availability. Run this check ONCE.

### Context7
Attempt: `mcp__context7__resolve-library-id` with libraryName="react" query="react library"
- **Success:** Set context7_available = true. Proceed with standard mcp_protocol verification.
- **Failure:** Set context7_available = false. Skip Step 2 (Context7 API Verification) in mcp_protocol. Rely on RESEARCH.md findings and plan instructions. Tag any unverified API usage in SUMMARY.md: "API not verified (Context7 unavailable)."

### Mid-Session Failures
Even after pre-flight succeeds, wrap Context7 calls in try/catch. If a call fails mid-session:
1. Log: "Context7 became unavailable mid-session"
2. Skip remaining Context7 verifications
3. Note in SUMMARY.md which APIs were not verified
4. Do NOT retry -- assume unavailable for the session

### Fallback Behavior
When Context7 is unavailable:
- Step 1 (Read RESEARCH.md) is unchanged -- always do this
- Step 2 (Context7 verify) is SKIPPED -- proceed with plan instructions
- Step 3 (Load best-practice skills) is unchanged -- skill files are local, not MCP-dependent

</mcp_degradation>
```

**Part C: Sync global copies**

Copy the updated researcher file to `~/.claude/agents/gsd-phase-researcher.md` and the updated executor file to `~/.claude/agents/gsd-executor.md`. These global copies must stay in sync with the references/ copies.

Note: The global copies at ~/.claude/agents/ are older versions. When syncing, copy the FULL updated references/ version (which includes the Phase 2 mcp_protocol AND the new mcp_degradation), not just append the new section.
  </action>
  <verify>
Grep each updated file for "mcp_degradation" to confirm the section exists. Grep for "context7_available" to confirm the pre-flight pattern. Grep for "Mid-Session Failures" to confirm try/catch guidance. Diff the references/ copy against the ~/.claude/agents/ copy to confirm they are in sync.
  </verify>
  <done>
Researcher and executor agent definitions both contain `<mcp_degradation>` sections with pre-flight checks, fallback paths, mid-session failure handling, and confidence tagging tables. Global copies synced.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add MCP degradation to browser-tester and code-reviewer, add RESEARCH.md-first to planner</name>
  <files>
    skills/gsd-verify-work/references/agents/gsd-browser-tester.md
    skills/gsd-review/references/agents/gsd-code-reviewer.md
    skills/gsd-plan-phase/references/agents/gsd-planner.md
    ~/.claude/agents/gsd-planner.md
  </files>
  <action>
**Part A: Browser-tester agent (gsd-browser-tester.md)**

The browser-tester already has a pre-flight check (Step 3 checks `mcp__chrome-devtools__list_pages`). Enhance it:

1. Add a `<mcp_degradation>` section AFTER `<non_ui_handling>` with:
```markdown
<mcp_degradation>

## Chrome DevTools Degradation

The pre-flight check in Step 3 already handles Chrome DevTools unavailability by setting status to "inconclusive". This section adds confidence tagging to the report.

### Confidence in Report
When Chrome DevTools IS available and tests run:
- Tag report: `confidence: HIGH` in frontmatter
- Evidence from snapshots, console, and network is direct observation

When Chrome DevTools is NOT available (inconclusive):
- Tag report: `confidence: N/A` in frontmatter
- Report notes: "Runtime verification not performed -- Chrome DevTools unavailable"

### Frontmatter Addition
Add to RUNTIME-VERIFICATION.md frontmatter:
```yaml
confidence: HIGH | N/A
```

</mcp_degradation>
```

2. Update the `<report_output>` section's frontmatter template to include `confidence: HIGH | N/A` as a new field after the existing `chrome_devtools` field.

**Part B: Code-reviewer agent (gsd-code-reviewer.md)**

Add a `<mcp_degradation>` section AFTER `<critical_rules>`:

```markdown
<mcp_degradation>

## IDE Diagnostics Degradation

### Pre-flight
The IDE diagnostics MCP (`mcp__ide__getDiagnostics`) may be unavailable if no IDE is connected.

### Step 4 Fallback
When `mcp__ide__getDiagnostics` fails or returns no response:
1. Note: "IDE diagnostics unavailable -- relying solely on TypeScript compiler"
2. Skip Step 4A (IDE diagnostics)
3. Step 4B (typecheck) becomes the SOLE source of type error information
4. Cross-verification rules simplify: treat typecheck results as authoritative without cross-reference

### In REVIEW.md
When IDE diagnostics unavailable:
- Set frontmatter field: `ide_errors: N/A`
- In Test Results section: "IDE diagnostics: N/A (MCP unavailable -- typecheck is authoritative)"

</mcp_degradation>
```

**Part C: Planner agent -- RESEARCH.md-first protocol (TOKEN-03)**

The planner (`gsd-planner.md`) currently does NOT have a "check RESEARCH.md before Context7" pattern. The executor has it (Phase 2 addition). Add consistency by inserting a note in the planner's `<discovery_levels>` section.

After the "Level 1 - Quick Verification" entry (line ~109), add:

```markdown
**RESEARCH.md-first rule:** Before any Context7 query, check if `{phase_dir}/*-RESEARCH.md` already covers the library/topic. If RESEARCH.md has a HIGH-confidence entry for that library, skip the Context7 lookup entirely. This avoids double-querying what the researcher already verified.
```

This aligns with the existing decision: "Phase 02-01: Planner trusts HIGH-confidence RESEARCH.md entries instead of re-querying Context7."

Also sync the updated planner to `~/.claude/agents/gsd-planner.md`.

Note: The planner at ~/.claude/agents/gsd-planner.md IS this planner agent. Update it with the RESEARCH.md-first addition.
  </action>
  <verify>
Grep browser-tester for "mcp_degradation" and "confidence". Grep code-reviewer for "mcp_degradation" and "IDE diagnostics unavailable". Grep planner for "RESEARCH.md-first" to confirm the new protocol. Verify the planner at ~/.claude/agents/ is updated.
  </verify>
  <done>
Browser-tester includes confidence tagging in report frontmatter. Code-reviewer handles IDE diagnostics unavailability gracefully. Planner checks RESEARCH.md before Context7 queries. All four MCP-using agent types have degradation handling. Global copies synced.
  </done>
</task>

</tasks>

<verification>
1. All 4 agent definitions contain `<mcp_degradation>` sections: researcher, executor, browser-tester, code-reviewer
2. Researcher has pre-flight checks for Context7 AND microsoft-docs
3. Executor has pre-flight for Context7 with fallback that skips verification
4. Browser-tester has confidence tagging in RUNTIME-VERIFICATION.md frontmatter
5. Code-reviewer falls back to typecheck-only when IDE diagnostics unavailable
6. Planner has RESEARCH.md-first rule in discovery_levels section
7. Global copies at ~/.claude/agents/ are synced with references/ copies
</verification>

<success_criteria>
MCP-08 and TOKEN-03 are complete: all MCP-using agents handle unavailability with pre-flight checks, fallback paths, mid-session failure handling, and confidence tagging. Research caching is consistent across all agents.
</success_criteria>

<output>
After completion, create `.planning/phases/04-resilience-optimization/04-02-SUMMARY.md`
</output>
