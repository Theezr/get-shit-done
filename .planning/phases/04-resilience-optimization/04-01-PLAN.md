---
phase: 04-resilience-optimization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/get-shit-done/bin/gsd-tools.js
autonomous: true

must_haves:
  truths:
    - "gsd-tools.js `requirements get-phase N` returns only requirements mapped to that phase"
    - "gsd-tools.js `roadmap get-phase N --format section` returns the raw markdown section for the phase"
    - "gsd-tools.js `phase-plan-index` output includes `type` field for each plan"
  artifacts:
    - path: "~/.claude/get-shit-done/bin/gsd-tools.js"
      provides: "requirements get-phase command, roadmap --format option, type in plan index"
      contains: "cmdRequirementsGetPhase"
  key_links:
    - from: "gsd-tools.js requirements get-phase"
      to: ".planning/REQUIREMENTS.md Traceability table"
      via: "regex parsing of Phase column"
      pattern: "Traceability"
    - from: "gsd-tools.js phase-plan-index"
      to: "plan frontmatter type field"
      via: "extractFrontmatter"
      pattern: "fm\\.type"
---

<objective>
Add phase-specific extraction commands to gsd-tools.js so agents can request only the data they need instead of reading entire files.

Purpose: Reduce token consumption (TOKEN-04) by giving agents targeted extraction instead of full-file reads of REQUIREMENTS.md and ROADMAP.md.
Output: Extended gsd-tools.js with `requirements get-phase`, enhanced `roadmap get-phase --format`, and `type` field in `phase-plan-index`.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/04-resilience-optimization/04-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add requirements get-phase command to gsd-tools.js</name>
  <files>~/.claude/get-shit-done/bin/gsd-tools.js</files>
  <action>
Add a new `cmdRequirementsGetPhase(cwd, phaseNum, raw)` function and wire it into the command dispatcher.

**Function implementation:**
1. Read `.planning/REQUIREMENTS.md`
2. Parse the Traceability table (the `| Requirement | Phase | Status |` table near the bottom) to find all requirement IDs mapped to the given phase number
3. For each requirement ID found in the Traceability table, extract its description from the `## v1 Requirements` section (pattern: `**REQ-ID**: description text`)
4. Return JSON: `{ found: boolean, phase: string, count: number, requirements: [{ id, phase, status, description }] }`

**Dispatcher wiring:**
Add a new `case 'requirements':` block in the main switch statement. Support subcommand `get-phase` with phase number as the argument:
```
case 'requirements':
  if (subcommand === 'get-phase') {
    cmdRequirementsGetPhase(cwd, args[2], raw);
  }
```

**Edge cases to handle:**
- REQUIREMENTS.md not found: return `{ found: false, error: "REQUIREMENTS.md not found" }`
- Phase number not provided: call `error('phase number required')`
- No requirements found for phase: return `{ found: false, phase: phaseNum, count: 0, requirements: [] }`
- Requirement ID found in Traceability but description not found in v1 section: set `description: null`

**Test after implementation:**
```bash
node ~/.claude/get-shit-done/bin/gsd-tools.js requirements get-phase 4
```
Expected: Returns MCP-08, TOKEN-03, TOKEN-04, TOKEN-05 with their descriptions.
  </action>
  <verify>
Run `node ~/.claude/get-shit-done/bin/gsd-tools.js requirements get-phase 4` and confirm it returns JSON with 4 requirements (MCP-08, TOKEN-03, TOKEN-04, TOKEN-05). Run `node ~/.claude/get-shit-done/bin/gsd-tools.js requirements get-phase 1` and confirm it returns Phase 1 requirements (SKILL-01, SKILL-02, SKILL-05, TOKEN-01, TOKEN-02, PIPE-02, PIPE-03, PIPE-06).
  </verify>
  <done>
`requirements get-phase N` returns correct requirement IDs, phases, statuses, and descriptions for any valid phase number. Returns empty results gracefully for non-existent phases.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend roadmap get-phase with --format option and add type to phase-plan-index</name>
  <files>~/.claude/get-shit-done/bin/gsd-tools.js</files>
  <action>
**Part A: Add --format option to roadmap get-phase**

Modify `cmdRoadmapGetPhase` to accept an optional `--format` parameter:
- `--format json` (default, current behavior): Returns JSON with `found`, `phase_number`, `phase_name`, `goal`, `section`
- `--format section`: Returns ONLY the raw markdown section text (no JSON wrapping) -- useful for agents that want to inject the section directly into context

Update the dispatcher in `case 'roadmap':` to parse `--format` from args:
```javascript
if (subcommand === 'get-phase') {
  const formatIndex = args.indexOf('--format');
  const format = formatIndex !== -1 ? args[formatIndex + 1] : 'json';
  cmdRoadmapGetPhase(cwd, args[2], raw, format);
}
```

In the function, when `format === 'section'`, output the raw section text directly (use the `output` function's third parameter for raw text output, or `console.log(section)` when raw mode is on).

**Part B: Add type field to phase-plan-index output**

In `cmdPhasePlanIndex`, after extracting `autonomous` from frontmatter (around line 1786), also extract the `type` field:

```javascript
const planType = fm.type || 'execute';
```

Add `type: planType` to the plan object (alongside `id`, `wave`, `autonomous`, etc.):

```javascript
const plan = {
  id: planId,
  wave,
  autonomous,
  type: planType,   // <-- ADD THIS
  objective: fm.objective || null,
  // ...existing fields
};
```

This enables the execute-phase orchestrator to conditionally load TDD/checkpoint references based on plan type.

**Test after implementation:**
```bash
node ~/.claude/get-shit-done/bin/gsd-tools.js roadmap get-phase 4 --format section
node ~/.claude/get-shit-done/bin/gsd-tools.js phase-plan-index 04
```
  </action>
  <verify>
Run `node ~/.claude/get-shit-done/bin/gsd-tools.js roadmap get-phase 4 --format section` and confirm it outputs the raw markdown section for Phase 4. Run `node ~/.claude/get-shit-done/bin/gsd-tools.js roadmap get-phase 4` (no --format) and confirm JSON output still works. Run `node ~/.claude/get-shit-done/bin/gsd-tools.js phase-plan-index 01` and confirm each plan object includes a `type` field.
  </verify>
  <done>
`roadmap get-phase N --format section` outputs raw markdown. Default format unchanged. `phase-plan-index` includes `type` field in each plan's JSON output.
  </done>
</task>

</tasks>

<verification>
1. `node ~/.claude/get-shit-done/bin/gsd-tools.js requirements get-phase 4` returns 4 requirements with descriptions
2. `node ~/.claude/get-shit-done/bin/gsd-tools.js requirements get-phase 1` returns 8 Phase 1 requirements
3. `node ~/.claude/get-shit-done/bin/gsd-tools.js requirements get-phase 99` returns `found: false, count: 0` (no crash)
4. `node ~/.claude/get-shit-done/bin/gsd-tools.js roadmap get-phase 4 --format section` outputs raw Phase 4 markdown section
5. `node ~/.claude/get-shit-done/bin/gsd-tools.js roadmap get-phase 4` returns JSON (backward compatible)
6. `node ~/.claude/get-shit-done/bin/gsd-tools.js phase-plan-index 01` includes `type: "execute"` in plan objects
</verification>

<success_criteria>
All three gsd-tools.js enhancements work correctly: requirements extraction by phase, roadmap section formatting, and plan type in index. No regressions in existing commands.
</success_criteria>

<output>
After completion, create `.planning/phases/04-resilience-optimization/04-01-SUMMARY.md`
</output>
